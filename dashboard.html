<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crime Town Video Dashboard</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #111;
      color: #ddd;
      margin: 0;
      padding: 20px;
    }
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      border-bottom: 1px solid #ff4444;
      padding-bottom: 10px;
    }
    #userWelcome {
      color: #ff4444;
      font-size: 1.2em;
    }
    #logoutBtn {
      background: #333;
      color: #ddd;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
    }
    #logoutBtn:hover {
      background: #444;
    }
    #uploadSection {
      background: rgba(25, 25, 25, 0.7);
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      border: 1px solid #ff4444;
    }
    #dropArea {
      border: 2px dashed #444;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      border-radius: 6px;
    }
    #dropArea.highlight {
      background: rgba(255, 68, 68, 0.1);
      border-color: #ff4444;
    }
    #videoGallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
    }
    .videoCard {
      background: rgba(25, 25, 25, 0.7);
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid #333;
      transition: transform 0.3s;
    }
    .videoCard:hover {
      transform: translateY(-5px);
      border-color: #ff4444;
    }
    .videoCard video, .videoCard img {
      width: 100%;
      display: block;
      max-height: 200px;
      object-fit: contain;
      background: #000;
    }
    .videoInfo {
      padding: 15px;
    }
    .videoTitle {
      font-weight: bold;
      margin-bottom: 5px;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .videoMeta {
      font-size: 0.9em;
      color: #999;
    }
    .delete-btn {
      float: right;
      background: #ff4444;
      color: white;
      border: none;
      padding: 2px 8px;
      border-radius: 3px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="header">
    <h1>Crime Town Videos</h1>
    <div>
      <span id="userWelcome">Welcome, Guest</span>
      <button id="logoutBtn">Logout</button>
    </div>
  </div>

  <!-- Upload Section - Now visible to all logged-in users -->
  <div id="uploadSection">
    <h2>Upload New Media</h2>
    <div id="dropArea">
      <p>Drag & drop files here</p>
      <p>or click to browse files</p>
      <input type="file" id="fileInput" accept="video/*,image/*" style="display:none">
    </div>
  </div>

  <!-- Media Gallery -->
  <div id="videoGallery"></div>

  <script>
    // Get current user from URL
    const params = new URLSearchParams(window.location.search);
    const currentUser = params.get('user') || 'Guest';
    
    // Initialize UI
    document.getElementById('userWelcome').textContent = `Welcome, ${currentUser}`;

    // Media storage in localStorage
    let mediaItems = JSON.parse(localStorage.getItem('crimeTownMedia') || '[]');

    // Initialize upload functionality for all users
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');

    // Handle click on drop area
    dropArea.addEventListener('click', () => fileInput.click());

    // Drag and drop events
    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, highlight);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, unhighlight);
    });

    function highlight(e) {
      e.preventDefault();
      dropArea.classList.add('highlight');
    }

    function unhighlight(e) {
      e.preventDefault();
      dropArea.classList.remove('highlight');
    }

    // Handle dropped file
    dropArea.addEventListener('drop', handleDrop);

    // Handle selected file
    fileInput.addEventListener('change', handleFileSelect);

    function handleDrop(e) {
      const file = e.dataTransfer.files[0];
      if (file) processUploadedFile(file);
    }

    function handleFileSelect() {
      if (fileInput.files[0]) processUploadedFile(fileInput.files[0]);
    }

    // Process uploaded file
    function processUploadedFile(file) {
      const validTypes = ['video/', 'image/'];
      if (!validTypes.some(type => file.type.startsWith(type))) {
        alert('Please select a video (MP4, etc.) or image (JPG, PNG, etc.) file');
        return;
      }

      const fileURL = URL.createObjectURL(file);
      
      mediaItems.unshift({
        name: file.name,
        size: file.size,
        type: file.type,
        uploader: currentUser,
        url: fileURL,
        timestamp: new Date().toISOString()
      });
      
      localStorage.setItem('crimeTownMedia', JSON.stringify(mediaItems));
      displayMedia();
      fileInput.value = '';
    }

    // Display all media
    function displayMedia() {
      const gallery = document.getElementById('videoGallery');
      gallery.innerHTML = '';
      
      if (mediaItems.length === 0) {
        gallery.innerHTML = '<p>No media available yet.</p>';
        return;
      }
      
      mediaItems.forEach((media, index) => {
        const mediaCard = document.createElement('div');
        mediaCard.className = 'videoCard';
        
        let mediaElement;
        if (media.type.startsWith('video')) {
          mediaElement = `<video controls src="${media.url}"></video>`;
        } else {
          mediaElement = `<img src="${media.url}" alt="${media.name}">`;
        }
        
        const canDelete = (currentUser === media.uploader);
        const deleteButton = canDelete 
          ? `<button onclick="deleteMedia(${index})" class="delete-btn">Delete</button>`
          : '';
        
        mediaCard.innerHTML = `
          ${mediaElement}
          <div class="videoInfo">
            <div class="videoTitle" title="${media.name}">${media.name}</div>
            <div class="videoMeta">
              Uploaded by: <span class="uploader">${media.uploader}</span><br>
              ${formatFileSize(media.size)} â€¢ ${new Date(media.timestamp).toLocaleString()}
              ${deleteButton}
            </div>
          </div>
        `;
        gallery.appendChild(mediaCard);
      });
    }

    // Delete media
    function deleteMedia(index) {
      if (currentUser !== mediaItems[index].uploader) {
        alert("You can only delete your own uploads");
        return;
      }
      
      if (!confirm('Delete this file?')) return;
      
      mediaItems.splice(index, 1);
      localStorage.setItem('crimeTownMedia', JSON.stringify(mediaItems));
      displayMedia();
    }

    // Format file size
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' bytes';
      if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / 1048576).toFixed(1) + ' MB';
    }

    // Logout button
    document.getElementById('logoutBtn').addEventListener('click', () => {
      window.location.href = 'crimetown.online.html';
    });

    // Initial display
    displayMedia();
  </script>
</body>
</html>